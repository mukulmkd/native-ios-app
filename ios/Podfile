require_relative '../js/node_modules/react-native/scripts/react_native_pods'

platform :ios, '16.0'

project 'NativeIOSApp/NativeIOSApp.xcodeproj'

target 'NativeIOSApp' do
  use_react_native!(
    :path => '../js/node_modules/react-native',
    :hermes_enabled => true, # React Native 0.81.5 requires Hermes
    :fabric_enabled => false,
    :new_arch_enabled => false
  )
  
  # Explicitly link AsyncStorage with legacy architecture
  pod 'RNCAsyncStorage', :path => '../js/node_modules/@react-native-async-storage/async-storage', :modular_headers => true
end

# Configure React Native build settings
post_install do |installer|
  react_native_path = File.join(__dir__, '..', 'js', 'node_modules', 'react-native')
  
  installer.pods_project.targets.each do |target|
    # Set REACT_NATIVE_PATH for all targets (needed for codegen)
    target.build_configurations.each do |config|
      config.build_settings['REACT_NATIVE_PATH'] = react_native_path
      # Fix deployment target (must be at least 12.0)
      if config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'].to_f < 12.0
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '12.0'
      end
      
      # For AsyncStorage specifically, ensure new architecture is NOT defined
      # The header uses #ifdef, so we need to remove it completely, not set to 0
      if target.name == 'RNCAsyncStorage'
        # Remove RCT_NEW_ARCH_ENABLED from preprocessor definitions completely
        if config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
          config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'].reject { |d| d.include?('RCT_NEW_ARCH_ENABLED') }
        end
        # Also remove from other_defines if present
        if config.build_settings['OTHER_CPLUSPLUSFLAGS']
          config.build_settings['OTHER_CPLUSPLUSFLAGS'] = config.build_settings['OTHER_CPLUSPLUSFLAGS'].reject { |d| d.include?('RCT_NEW_ARCH_ENABLED') }
        end
        # Remove the build setting
        config.build_settings.delete('RCT_NEW_ARCH_ENABLED')
      else
        # For other pods, disable new architecture
        config.build_settings['RCT_NEW_ARCH_ENABLED'] = '0'
        # Also remove any preprocessor definitions that might enable it
        if config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
          config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'].reject { |d| d.include?('RCT_NEW_ARCH_ENABLED') }
        end
      end
    end
  end
  
  # Disable sandbox for embed frameworks build phase in main app target
  main_project_path = File.join(__dir__, 'NativeIOSApp', 'NativeIOSApp.xcodeproj', 'project.pbxproj')
  if File.exist?(main_project_path)
    project_content = File.read(main_project_path)
    # Disable user script sandboxing globally (this is the key setting!)
    project_content = project_content.gsub(
      /ENABLE_USER_SCRIPT_SANDBOXING = YES;/,
      'ENABLE_USER_SCRIPT_SANDBOXING = NO;'
    )
    # Also add disableSandbox = 1 to the embed frameworks build phase
    unless project_content.include?('disableSandbox = 1')
      project_content = project_content.gsub(
        /(shellScript = ".*?Pods-NativeIOSApp-frameworks\.sh.*?";\n\t\t)(showEnvVarsInLog = \d+;)/,
        "\\1disableSandbox = 1;\n\t\t\\2"
      )
    end
    # Disable new architecture in main app target
    project_content = project_content.gsub(
      /(RCT_NEW_ARCH_ENABLED\s*=\s*)YES;/,
      '\\1NO;'
    )
    project_content = project_content.gsub(
      /(RCT_NEW_ARCH_ENABLED\s*=\s*)\d+;/,
      '\\10;'
    )
    File.write(main_project_path, project_content)
  end
  
  # Also update the script to use cp -R instead of rsync
  frameworks_script_path = File.join(__dir__, 'Pods', 'Target Support Files', 'Pods-NativeIOSApp', 'Pods-NativeIOSApp-frameworks.sh')
  if File.exist?(frameworks_script_path)
    script_content = File.read(frameworks_script_path)
    # Replace rsync commands with cp -R
    script_content = script_content.gsub(
      /rsync --delete -av ".*?" --links --filter.*?"\$\{source\}" "\$\{destination\}"/,
      'rm -rf "$destination/$(basename "$source")" && cp -R "$source" "$destination"'
    ) unless script_content.include?('cp -R "$source" "$destination"')
    File.write(frameworks_script_path, script_content)
  end
end
